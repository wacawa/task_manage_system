<%= javascript_pack_tag 'users/show' %>

<div class="time-boxing secondary">

  <% if @within %>
    <div class="now-line"></div>
  <% end %>
  <%# <div class="task secondary"></div> %>

  <% @tasks.each do |task| %>
    <% st = task.start_time %>
    <% ft = task.finish_time %>
    <% range = ((task.finish_time - task.start_time) / 60).to_i %>
    <% overflow = range >= 40 ? "" : "overflow" %>
    <% sticky = overflow.blank? ? "sticky" : "" %>
    <% day = "%02d" % st.day %>
    <% hour = "%02d" % st.hour %>
    <% min = "%02d" % st.min %>
    <% cname1 = "task_dhm_#{day+hour+min}" %>
    <% cname2 = "range_#{range}" %>
    <% fhour = "%02d" % ft.hour %>
    <% fmin = "%02d" % ft.min %>
    <% if @edit_task.present? && task.id == @edit_task.id %>
      <div class="task <%= cname1 %> <%= cname2 %> task-form overflow">
        <%= form_with(model: task, url: user_task_path(@user, task), local: true) do |f| %>
            <%= f.text_field :title, class: "form-control text-secondary" %>
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              <%= f.time_field :start_time, class: "form-control text-secondary" %>
            </div>
            <div class="col-auto">
            〜
            </div>
            <div class="col-auto">
              <%= f.time_field :finish_time, class: "form-control  text-secondary" %>
            </div>
          </div>
            <%= f.text_area :memo, rows: "5", class: "form-control text-secondary" %>
            <%= f.hidden_field :start_datetime %>
            <%= f.submit "送信", class: "btn btn-light btn-outline-secondary" %>
            <%= link_to "キャンセル", session[:default_url], class: "btn btn-light btn-outline-secondary" %>
        <% end %>
      </div>
    <% else %>
      <%= link_to user_path(year: params[:year], month: params[:month], day: params[:day], hour: params[:hour], task_id: task.id) do %>
        <div class="task <%= cname1 %> <%= cname2 %> <%= overflow %>">
          <div class="<%= sticky %>">
            <h4 class="task-title"><%= task.title %></h4>
            <div class="time-range"><%= " #{hour} : #{min} 〜 #{fhour} : #{fmin} " %></div>
            <div class="memo"><%= task.memo.nil? ? task.memo : safe_join(task.memo.split("\n"),tag(:br)) %></div>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>

  <div class="row">
    <div class="col-md-10 offset-md-1">
      <div class="axis"></div>
      <div class="time">
        <% day = @day[0] %>
        <% for hour in [*@hour..@end_hour] do %>
          <% h = hour % 24 %>
          <% day = @day[1] if @hour != 0 && h == 0 %>
          <% d = "%02d" % day %>
          <% h = "%02d" % h %>
          <% if hour != @end_hour %>
            <% for m in 0..59 do %>
              <% cname = m == 0 ? "hour" : "" %>
              <% m = "%02d" % m %>
              <% dhm = "dhm_#{d+h+m}" %>
              <div class="<%= dhm %> <%= cname %>"><%= "#{h.to_i} : #{m}" if m == "00" %></div>
            <% end %>
          <% else %>
            <div class="<%= d+h %>00 hour"><%= "#{h.to_i} : 00" %></div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
  <% if @within %>
    <div class="addtask">
      <%= link_to new_user_task_path(@user, day: @day[0], hour: @hour), remote: true do %> 
        <canvas id="plus" width="100" height="100"></canvas>
      <% end %>
    </div>
    <div class="mail">
      <% time_hash = {year: @time.year, month: @time.month, day: @time.day, hour: @time.hour} %>
      <%= link_to send_mail_user_path(@user, time_hash), method: :post do %>
        <%= image_tag("mail.png") %>
      <% end %>
    </div>
  <% end %>
</div>
<div class="modal task-modal"></div>
<div class="modal registration"></div>


<%
=begin
%>

    <div class="time-line secondary">
      <% for t in 0..24 do %>
        <% if t < 24 %>
        <p class="hour_<%= t %> space"><%= " #{t} : 00 " %></p>
        <% else %>
        <p class="hour_<%= t %>"><%= " #{t} : 00 " %></p>
          <%# <div class="space"></div> %>
        <%# for m in 0..60 do %>
          <%# <br> %>
        <%# end %>
        <% end %>
      <% end %>
    </div>
    <div class="absolute col-md-7">
      <% for m in 1..1440 do %>
        <% m %= 60 %>
        <div class="task"><%= m %></div>
      <% end %>
    </div>



  <footer>
    <canvas id="clock"></canvas>
    <%= debug(params) if Rails.env.development? %>
  </footer>
</div>

<%
=end
%>

